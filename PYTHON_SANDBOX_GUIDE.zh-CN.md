# Python 沙箱服务：用户与开发者指南

## 1. 概述

Python 沙箱服务提供了一个安全、隔离的环境，用于执行任意的 Python 代码片段。它主要被设计为供 AI 模型使用的工具，使其能够执行计算、运行算法和处理数据，而不会对主机系统带来任何安全风险。

其核心设计理念是 **“安全第一”**。服务的每个组件都旨在最小化风险，并假设所有待执行的代码都是不可信的，甚至是恶意的。每次代码执行都是完全临时的、无状态的。

## 2. 核心能力与安全设计

该服务的强大之处在于其多层安全模型，该模型严格定义了代码能做什么和不能做什么。

### 2.1 安全层级

-   **Docker 容器隔离**: 每一段代码都在其专属的、一次性的 Docker 容器中运行，该容器基于 `python:3.11-slim` 镜像。容器在执行后会被自动销毁，确保不会在两次运行之间保留任何状态。
-   **无网络访问**: 容器以 `network_disabled=True` 模式启动。这完全保证了被执行的代码无法进行任何内部或外部的网络调用。
-   **只读文件系统**: 容器的文件系统以只读模式挂载 (`read_only=True`)。代码无法在容器内写入或修改任何文件。
-   **严格的资源限制**: 为防止拒绝服务攻击或资源滥用，每个容器的资源上限被严格限制在 **256MB 内存** 和 **半个 CPU 核心**。
-   **受限的 Python 内置函数**: 这是最内层的安全机制。在用户的代码被执行之前，Python 运行时本身被修改，仅允许一个极小的、安全的内置函数子集。能够绕过安全限制的危险函数（如 `open`, `import`, `eval` 等）均被移除。

### 2.2 可用库与函数

#### 允许的内置函数
以下是代码中可用的 Python `__builtins__` 的完整列表：
`print`, `len`, `range`, `str`, `int`, `float`, `bool`, `list`, `dict`, `set`, `tuple`, `max`, `min`, `sum`, `abs`, `round`。

任何使用未在此列表中的内置函数的尝试都会导致错误。

#### Python 标准库
Python 3.11 标准库中绝大多数 **不执行** 网络或文件系统操作的模块都是可用的。由于 `import` 语句在主执行作用域中被禁用，这些模块只能在用户提供的代码片段 *内部* 被导入和使用。

**可用标准库示例:**
- `math`: 用于高级数学计算。
- `random`: 用于生成随机数。
- `datetime`: 用于时间和日期处理。
- `re`: 用于基于正则表达式的文本处理。
- `json`: 用于处理 JSON 数据结构。
- `collections`: 用于高级数据结构。

#### 第三方库
**无。** 基础 Docker 镜像 (`python:3.11-slim`) 是一个最小化版本，不包含任何第三方库，如 `numpy`, `pandas`, `requests` 等。

## 3. 使用场景与示例

该服务特别适用于纯计算或算法类型的任务。

### 场景一: 高级计算器
使用该服务来解决超出基本算术范围的复杂数学表达式或问题。

**示例代码:**
```python
import math

# 计算直角三角形的斜边
a = 15
b = 20
c = math.sqrt(a**2 + b**2)
print(f"斜边长度是: {c}")

# 计算阶乘
print(f"6的阶乘是: {math.factorial(6)}")
```

### 场景二: 数据处理与算法任务
执行诸如排序、筛选或转换数据结构等操作。

**示例代码:**
```python
# 根据特定键对字典列表进行排序
data = [
    {'name': 'Alice', 'age': 30},
    {'name': 'Bob', 'age': 25},
    {'name': 'Charlie', 'age': 35}
]
sorted_data = sorted(data, key=lambda x: x['age'])
print(sorted_data)
```

### 场景三: 文本处理
使用正则表达式或字符串方法来解析和分析文本。

**示例代码:**
```python
import re

text = "The quick brown fox jumps over the lazy dog. The fox is happy."
# 查找所有 "fox"
matches = re.findall(r'fox', text)
print(f"找到 'fox' {len(matches)} 次。")
```

## 4. 局限性

了解此服务 **不能** 做什么至关重要：
-   **无网络访问**: 无法调用 API、下载文件或访问任何网络资源。
-   **无文件 I/O**: 无法读取或写入任何文件。
-   **无第三方库**: 无法使用 `numpy`, `pandas`, `matplotlib`, `requests` 等流行库。
-   **无状态**: 每次执行都是独立的。一次运行中的变量或状态无法在下一次运行中使用。

## 5. 未来扩展与潜力

当前服务提供了一个强大但基础的功能。通过以下几种方式可以对其进行扩展，以解锁新的能力：

1.  **添加第三方库**:
    -   **方式**: 创建一个新的 `Dockerfile`，继承自 `python:3.11-slim`，并添加 `RUN pip install ...` 命令来安装受信任的流行库，例如 `numpy`, `pandas` (用于数据分析) 或 `sympy` (用于符号数学)。
    -   **影响**: 这将极大地增强服务在数据科学和数学任务方面的能力，使其成为一个真正的“代码解释器”。

2.  **启用绘图与图表功能**:
    -   **方式**: 在自定义 Docker 镜像中安装 `matplotlib` 等库。将其配置为使用非交互式后端（如 `agg`）。代码可以生成图表，保存到内存缓冲区（如 `io.BytesIO`），然后服务可以在 JSON 输出中以 base64 编码的字符串形式返回该图像。
    -   **影响**: 允许 AI 模型将数据可视化，根据计算结果创建图表。

3.  **引入有状态会话**:
    -   **方式**: 这是一个更复杂的架构变更。需要修改服务来为每个用户管理持久化的容器会话。请求中将包含一个 `session_id`，服务会把代码路由到对应的正在运行的容器中。同时需要一个超时机制来终止不活跃的会话。
    -   **影响**: 将允许迭代式的工作，模型可以在一次调用中定义变量，并在下一次调用中使用它，模拟真实的 Jupyter Notebook 体验。这需要仔细的安全考量以防止与状态相关的漏洞。

4.  **受控的文件系统访问**:
    -   **方式**: 为每次执行创建并挂载一个临时的、隔离的目录 (`tmpfs`) 到容器中。代码将被允许 *仅* 在此临时工作区内读写文件。服务可以被扩展，以选择性地返回指定的输出文件（例如生成的 CSV）作为响应的一部分。
    -   **影响**: 支持更复杂的数据处理任务，这些任务可能需要中间文件，或者最终产出是一个文件而不是纯文本。